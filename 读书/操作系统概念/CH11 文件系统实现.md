# CH 11 文件系统实现

## 1.文件系统结构

- 磁盘特点：
  - 可以原地重写
  - 可以直接访问磁盘上任意一块的信息
- 分层设计的文件系统
- 文件系统的设计问题：
- 如何定义文件系统对用户的接口
- 创建数据结构和算法来将逻辑文件系统映射到物理外存设备上
> 应用程序->逻辑文件系统->文件组织系统->基本文件系统->IO控制->设备
- IO控制  由设备驱动程序和中断处理程序组成，实现内存与磁盘之间的信息传输
- 基本文件系统 向设备发送指令
- 文件组织模块 管理文件逻辑块和物理块
- 逻辑文件系统 管理元数据：包括文件系统的所有结构数据，不包括实际数据结构
  - 通过FCB维护文件结构，FCB 文件控制块 File Control Block
- Unix：文件系统 UFS - 基于FFS
- Windows：文件系统 FAT FAT32 NTFS
- Linux：ext2 ext3

## 2.文件系统实现

- 文件系统概述
- 引导控制块：引导操作系统所需信息，引导块或分区引导扇区
- 卷控制块：包括卷详细信息，超级块或主控文件表
- 内存中的文件系统信息：
  - 安装表：所有安装卷信息
  - 目录结构缓存：保存最近访问的目录信息
  - 系统范围内打开的文件表：记录已打开文件的FCB和进程数量
  - 单个进程打开的文件表：一个指向系统范围打开文件表的指针和其他信息
- 创建新文件
  - 1.逻辑文件系统：分配FCB
  - 2.将目录信息读入内存；
  - 3.使用新文件名更新FCB和目录
  - 4.结果写会磁盘
- 对于目录的特殊处理：有的操作系统将目录视为文件，使用类型域标识是否为目录，有的操作系统将目录和文件分开调用
- 打开文件
  - 1.调用open到文件系统
  - 2.首先搜索系统范围打开文件表查找该文件，是否被其他进程使用，是：单个进程打开文件表中新建一项，指向系统范围打开文件表
  - 3.根据文件名搜索目录结构，找到文件后，复制其FCB到系统范围打开文件表
  - 4.进程打开文件表中新增条目，通过指针将系统范围打开文件表条目和其他域关联
  - 5.返回一个指向单个进程的打开文件表中合适条目的指针（UNIX：文件描述符，windows：文件句柄）
  - 6.关闭文件：删除一个相应的单个进程打开文件表的条目，系统范围打开文件表相应条目打开数量递减，若所有使用该文件的用户关闭文件，则系统范围打开文件表中该对应条目会删除
- 分区与安装
- 分区
- 生分区 raw：没有文件系统，EG:UNIX交换空间、部分DB
- 熟分区 cooked：有文件系统
- 引导信息：一组有序块，并作为镜像文件读入内存，指导如何启动一个操作系统
- 根分区 root partition：包括操作系统内核或其他系统文件，在引导时装入内存
- OS加载操作系统
  - 1.引导时加载根分区内容（装入内存），其他分区根据OS自动装入或者手动装入
  - 2.OS验证设备上的文件系统是否有效，若无效则检验分区是否一致，根据需要进行纠正
  - 3.OS在内存的装入表中注明已装入的文件系统和文件系统类型
- 虚拟文件系统 VFS
- OS在多个文件系统类型之间无缝切换，分开基本系统调用和实现细节
- 三个层次
  - 1.文件系统接口：open read write close 文件描述符
  - 2.VFS接口：定义VFS接口，将文件系统的通用操作和具体实现分开；提供网络上唯一标识一个文件的机制；
  - 3.多个具体的文件系统
- Linux VSF定义的4种主要对象：
  - 索引节点对象 inode object：表示一个单独的文件
  - 文件对象 file object：表示一个打开的文件
  - 超级块对象 superblock object：表示整个文件系统
  - 目录条目对象 dentry object：表示一个单独的目录条目
- 虚拟文件系统 VFS
- 屏蔽各种文件系统的差异
- VFS对每种类型对象定义一组必须实现的操作，该类型对象都包含一个指向函数表的指针，该函数表列出
- 
